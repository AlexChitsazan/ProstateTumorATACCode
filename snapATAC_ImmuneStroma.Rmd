---
title: "immuneATAC_SRA"
author: "Alex Chitsazan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## SNAPATAC



```{r}


ImmuneOnly.lda.sp<- AllSamplesDecember.lda.sp[grep("Immune|Stroma", AllSamplesDecember.lda.sp@metaData$EnrichedCluster),]
# fixInNamespace(runLDA, "SnapATAC")
# system.time({
# 	ImmuneOnly.lda.sp = SnapATAC::runLDA(
# 		obj=ImmuneOnly.lda.sp,
# 		input.mat = "bmat", 
# 		topic = c(10, 20, 30, 40, 50),
# 		method = "Z-score", 
# 		num.cores = 10, 
# 		min.cell = 10,
# 		seed.use = 10, 
# 		iterations = 500, 
# 		burnin = 250, 
# 		alpha = 50,
# 		alphaByTopic = TRUE, 
# 		beta = 0.1
# 		);
# 	})
ImmuneOnly.lda.sp <- readRDS("~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneStromaOnly.RDS")

ImmuneOnly.lda.sp = runKNN(
    obj=ImmuneOnly.lda.sp,
    eigs.dims =seq(ImmuneOnly.lda.sp@smat@sdev),
    weight.by.lambda = T,
    k=50)


## Clustering
library(leiden);
ImmuneOnly.lda.sp = runCluster(
	obj=ImmuneOnly.lda.sp,
	tmp.folder=tempdir(),
	louvain.lib="R-igraph",
	seed.use=10,resolution = 0.1
	);

## Visualization
ImmuneOnly.lda.sp = runViz(
	obj=ImmuneOnly.lda.sp, 
	tmp.folder=tempdir(),
	dims=2,
	eigs.dims =seq(ImmuneOnly.lda.sp@smat@sdev), 
	weight.by.sd=TRUE,
	method="umap",
	fast_tsne_path=NULL,
	Y.init=ImmuneOnly.lda.sp@umap,
	seed.use=10,
	num.cores=10
	);

plotViz(
	obj=ImmuneOnly.lda.sp, 
	method="umap", 
	point.size=0.2, 
	point.shape=19, 
	point.alpha=0.8, 
  	point.color=table(ImmuneOnly.lda.sp@metaData$SoftGleasonScore), 
	text.add=TRUE,
	text.size=0.5,
	text.color="black",
	text.halo.add=TRUE,
	text.halo.color="white",
	text.halo.width=0.2,
	down.sample=10000,
	pdf.file.name=NULL,
	pdf.width=7, 
	pdf.height=7,
	legend.add=T, 
	legend.pos = "top",
	main="snapATAC integrated LDA (cisTopic snapATAC)"
	)
plotViz(
	obj=ImmuneOnly.lda.sp, 
	method="umap", 
	point.size=0.2, 
	point.shape=19, 
	point.alpha=0.8, 
  	point.color=ImmuneOnly.lda.sp@cluster, 
	text.add=TRUE,
	text.size=0.5,
	text.color="black",
	text.halo.add=TRUE,
	text.halo.color="white",
	text.halo.width=0.2,
	down.sample=10000,
	pdf.file.name=NULL,
	pdf.width=7, 
	pdf.height=7,
	legend.add=T, 
	legend.pos = "top",
	main="snapATAC integrated LDA (cisTopic snapATAC)"
	)
plotGene(
	obj= ImmuneOnly.lda.sp,
	gene.names=c("PTPRC", "CD8A", "ITGAM", "SELL"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 2,
	plot.ncol = 2,
	low.value=0,
	high.value=0.75,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);


gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}
GetTopics <- function(model, Object) {
  modelMat <- t(scale(model$document_expects, center=TRUE, scale=TRUE))
  rownames(modelMat) <- paste(1:length(Object@metaData$barcode), Object@metaData$barcode, sep = "_")
  colnames(modelMat) <- paste("Topic", 1:ncol(modelMat), sep="_")
  return(modelMat)
}
heatmap <- function(Object, Topics, Anno_Vector, Anno_Name, outFolder, outFile) {
  anno_col <- data.frame(row.names = paste(1:length(Object@barcode), Object@barcode, sep = "_"),
                         Column=Anno_Vector)
  colnames(anno_col) <- Anno_Name
  num_colors = length(unique(anno_col[,1]))
  anno_colors = gg_color_hue(num_colors)
  names(anno_colors) <- sort(unique(anno_col[,1]))
  anno_colors <- list(Cluster = anno_colors)
  png(paste0(outFolder, "/", outFile, ".png"), 
      width = 11, 
      height = 8.5, 
      res = 300,
      units = "in")
  p1 <- pheatmap(data.matrix(Topics[order(anno_col[[Anno_Name]]),]),
                 hclustfun = function(x) hclust(x, method="ward.D2"),
                 scale = "row",
                 cluster_cols = T,
                 cluster_rows = F,show_rownames = F,
                 col=colorRampPalette(rev(brewer.pal(11, "RdBu"))[c(1:4,8:11)])(256),
                 annotation_row = anno_col,
                 annotation_colors = anno_colors,
                 cex=1, 
                 main =  paste0("Topic Per Cell By ", Anno_Name))
  print(p1)
  dev.off()
  pdf(paste0(outFolder, "/", outFile, ".pdf"), 
      width = 11, 
      height = 8.5)
  p1 <- pheatmap(data.matrix(Topics[order(anno_col[[Anno_Name]]),]),
                 hclustfun = function(x) hclust(x, method="ward.D2"),
                 scale = "row",
                 cluster_cols = T,
                 cluster_rows = F,show_rownames = F,
                 col=colorRampPalette(rev(brewer.pal(11, "RdBu"))[c(1:4,8:11)])(256),
                 annotation_row = anno_col,
                 annotation_colors = anno_colors,
                 cex=1, 
                 main = paste0("Topic Per Cell By ", Anno_Name))
  print(p1)
  dev.off()
}
library(pheatmap)
library(RColorBrewer)
selectedModel<- readRDS("~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/selected.ModelImmuneOnly.RDS")
heatmap(Object = ImmuneOnly.lda.sp,
        Topics = GetTopics(selectedModel, ImmuneOnly.lda.sp),
        Anno_Vector = ImmuneOnly.lda.sp@cluster,
        Anno_Name = "Cluster",
        outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/FiguresMay/",
        outFile = "ImmuneStromaTopicHeatmap_clusters")
library(tidyverse)
# SampleNames <- paste0("Sample_", 1:length(unique(AllSamplesDecember.lda.sp@sample)))
# names(SampleNames) <- unique(AllSamplesDecember.lda.sp@sample)
# AllSamplesDecember.lda.sp@metaData$SampleNamePaper <- plyr::revalue(AllSamplesDecember.lda.sp@sample, SampleNames)
# SampleNamesOut <- data.frame(CisTopic = names(SampleNames),
#               PaperName = SampleNames, 
#               row.names = 1:length(SampleNames))
# write.table(SampleNamesOut, 
#             file = "~/Box Sync/Alex_Data/Ece_scATAC/SnapATAC_February/SampleNameOut.txt", 
#             quote = F, 
#             sep = "\t", row.names = F, col.names = T)
plotUMAP <- function(snapObject, 
                     colorBy, 
                     colorByLegendName, 
                     LegendRow =2,
                     outFolder,
                     outFile) {
  plotDF <- data.frame(UMAP1=snapObject@umap[,1],
             UMAP2=snapObject@umap[,2],
             ColorBy=colorBy
             )
  colnames(plotDF)[3] <- colorByLegendName
  
  p1 <- ggplot(plotDF, aes_string(x = "UMAP1", y = "UMAP2", color = colorByLegendName)) +
    geom_point(size = 1) + 
    theme_bw() +
    theme(legend.position="bottom") +
    guides(color=guide_legend(override.aes = list(size=1),
                             nrow=LegendRow, 
                             byrow=TRUE)) +
    theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),plot.background=element_blank())
  png(paste0(outFolder, "/", outFile, ".png"), 
      width = 11, 
      height = 8.5, 
      res = 300,
      units = "in")
  print(p1)
  dev.off()
  pdf(paste0(outFolder, "/", outFile, ".pdf"), 
      width = 11, 
      height = 8.5)
  print(p1)
  dev.off()
}
library(tidyverse)
plotUMAP(snapObject = ImmuneOnly.lda.sp, 
        colorBy = ImmuneOnly.lda.sp@cluster,
        colorByLegendName = "Cluster",
        outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneStroma////", 
        outFile = "ImmuneStroma_UMAP_Cluster")
plotUMAP(snapObject = ImmuneOnly.lda.sp, 
        colorBy = ImmuneOnly.lda.sp@metaData$GleasonScore,
        colorByLegendName = "GleasonScore",
        outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneStroma///", 
        outFile = "ImmuneStroma_UMAP_CleasonScore")
dev.off()
write.table(ImmuneOnly.lda.sp@metaData, 
            file ="~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneStroma/ImmuneStroma_MetaData.txt",
            sep="\t",quote = F)
library(tidyverse)
plotUMAP(snapObject = ImmuneOnly.lda.sp, 
        colorBy = ImmuneOnly.lda.sp@metaData$SampleNamePaper,
        colorByLegendName = "SampleNamePaper",
        outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneStroma///", 
        outFile = "ImmuneStroma_UMAP_SampleNamePaper")
plotUMAP(snapObject = ImmuneOnly.lda.sp, 
        colorBy = ImmuneOnly.lda.sp@metaData$SoftGleasonScore,
        colorByLegendName = "GleasonScore",
        outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneStroma///", 
        outFile = "ImmuneStroma_UMAP_SampleNamePaper") 
dev.off()
library(GenomicRanges)
getTopicsBedFiles(TopicMatrix = getTopicWordMatrix(selectedModel = selectedModel), 
                  snapObject = ImmuneOnly.lda.sp, 
                  outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneOnlyTopics/",
                  nRegions = 1500)








AllSamplesDecember.lda.sp <- readRDS("~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/AllPlusDecemberMarch.RDS")
ImmuneOnly.lda.sp<- AllSamplesDecember.lda.sp[grep("Immune", AllSamplesDecember.lda.sp@metaData$EnrichedCluster),]
fixInNamespace(runLDA, "SnapATAC")
system.time({
	ImmuneOnly.lda.sp = SnapATAC::runLDA(
		obj=ImmuneOnly.lda.sp,
		input.mat = "bmat",
		topic = c(10, 20, 30, 40, 50),
		method = "Z-score",
		num.cores = 10,
		min.cell = 10,
		seed.use = 10,
		iterations = 500,
		burnin = 250,
		alpha = 50,
		alphaByTopic = TRUE,
		beta = 0.1
		);
})
saveRDS(ImmuneOnly.lda.sp, "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneOnlyUMAPED.RDS")
ImmuneOnly.lda.sp <- readRDS("~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneOnly.RDS")
ImmuneOnly.lda.sp = runKNN(
    obj=ImmuneOnly.lda.sp,
    eigs.dims =seq(ImmuneOnly.lda.sp@smat@sdev),
    weight.by.lambda = T,
    k=50)


## Clustering
library(leiden);
ImmuneOnly.lda.sp = runCluster(
	obj=ImmuneOnly.lda.sp,
	tmp.folder=tempdir(),
	louvain.lib="R-igraph",
	seed.use=10,resolution = 0.1
	);

## Visualization
ImmuneOnly.lda.sp = runViz(
	obj=ImmuneOnly.lda.sp, 
	tmp.folder=tempdir(),
	dims=2,
	eigs.dims =seq(ImmuneOnly.lda.sp@smat@sdev), 
	weight.by.sd=TRUE,
	method="umap",
	fast_tsne_path=NULL,
	Y.init=ImmuneOnly.lda.sp@umap,
	seed.use=10,
	num.cores=10
	);

plotViz(
	obj=ImmuneOnly.lda.sp, 
	method="umap", 
	point.size=0.2, 
	point.shape=19, 
	point.alpha=0.8, 
  	point.color=ImmuneOnly.lda.sp@metaData$SampleNamePaper, 
	text.add=TRUE,
	text.size=0.5,
	text.color="black",
	text.halo.add=TRUE,
	text.halo.color="white",
	text.halo.width=0.2,
	down.sample=10000,
	pdf.file.name=NULL,
	pdf.width=7, 
	pdf.height=7,
	legend.add=T, 
	legend.pos = "top",
	main="snapATAC integrated LDA (cisTopic snapATAC)"
	)
plotViz(
	obj=ImmuneOnly.lda.sp, 
	method="umap", 
	point.size=0.2, 
	point.shape=19, 
	point.alpha=0.8, 
  	point.color=ImmuneOnly.lda.sp@cluster, 
	text.add=TRUE,
	text.size=0.5,
	text.color="black",
	text.halo.add=TRUE,
	text.halo.color="white",
	text.halo.width=0.2,
	down.sample=10000,
	pdf.file.name=NULL,
	pdf.width=7, 
	pdf.height=7,
	legend.add=T, 
	legend.pos = "top",
	main="snapATAC integrated LDA (cisTopic snapATAC)"
	)
write.table(ImmuneOnly.lda.sp@metaData, 
            file ="~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneStroma/ImmuneOnly_MetaData.txt",
            sep="\t",quote = F)

plotGene(
	obj= ImmuneOnly.lda.sp,
	gene.names=c("PTPRC", "CD8A", "ITGAM", "CD19"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 2,
	plot.ncol = 2,
	low.value=0,
	high.value=0.75,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);


gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}
GetTopics <- function(model, Object) {
  modelMat <- t(scale(model$document_expects, center=TRUE, scale=TRUE))
  rownames(modelMat) <- paste(1:length(Object@metaData$barcode), Object@metaData$barcode, sep = "_")
  colnames(modelMat) <- paste("Topic", 1:ncol(modelMat), sep="_")
  return(modelMat)
}
heatmap <- function(Object, Topics, Anno_Vector, Anno_Name, outFolder, outFile) {
  anno_col <- data.frame(row.names = paste(1:length(Object@barcode), Object@barcode, sep = "_"),
                         Column=Anno_Vector)
  colnames(anno_col) <- Anno_Name
  num_colors = length(unique(anno_col[,1]))
  anno_colors = gg_color_hue(num_colors)
  names(anno_colors) <- sort(unique(anno_col[,1]))
  anno_colors <- list(Cluster = anno_colors)
  png(paste0(outFolder, "/", outFile, ".png"), 
      width = 11, 
      height = 8.5, 
      res = 300,
      units = "in")
  p1 <- pheatmap(data.matrix(Topics[order(anno_col[[Anno_Name]]),]),
                 hclustfun = function(x) hclust(x, method="ward.D2"),
                 scale = "row",
                 cluster_cols = T,
                 cluster_rows = F,show_rownames = F,
                 col=colorRampPalette(rev(brewer.pal(11, "RdBu"))[c(1:4,8:11)])(256),
                 annotation_row = anno_col,
                 annotation_colors = anno_colors,
                 cex=1, 
                 main =  paste0("Topic Per Cell By ", Anno_Name))
  print(p1)
  dev.off()
  pdf(paste0(outFolder, "/", outFile, ".pdf"), 
      width = 11, 
      height = 8.5)
  p1 <- pheatmap(data.matrix(Topics[order(anno_col[[Anno_Name]]),]),
                 hclustfun = function(x) hclust(x, method="ward.D2"),
                 scale = "row",
                 cluster_cols = T,
                 cluster_rows = F,show_rownames = F,
                 col=colorRampPalette(rev(brewer.pal(11, "RdBu"))[c(1:4,8:11)])(256),
                 annotation_row = anno_col,
                 annotation_colors = anno_colors,
                 cex=1, 
                 main = paste0("Topic Per Cell By ", Anno_Name))
  print(p1)
  dev.off()
}
library(pheatmap)
library(RColorBrewer)
selectedModel<- readRDS("~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneOnlyModel.RDS")
heatmap(Object = ImmuneOnly.lda.sp,
        Topics = GetTopics(selectedModel, ImmuneOnly.lda.sp),
        Anno_Vector = ImmuneOnly.lda.sp@cluster,
        Anno_Name = "Cluster",
        outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneOnly//",
        outFile = "ImmuneOnlyTopicHeatmap_clusters")
library(tidyverse)
# SampleNames <- paste0("Sample_", 1:length(unique(AllSamplesDecember.lda.sp@sample)))
# names(SampleNames) <- unique(AllSamplesDecember.lda.sp@sample)
# AllSamplesDecember.lda.sp@metaData$SampleNamePaper <- plyr::revalue(AllSamplesDecember.lda.sp@sample, SampleNames)
# SampleNamesOut <- data.frame(CisTopic = names(SampleNames),
#               PaperName = SampleNames, 
#               row.names = 1:length(SampleNames))
# write.table(SampleNamesOut, 
#             file = "~/Box Sync/Alex_Data/Ece_scATAC/SnapATAC_February/SampleNameOut.txt", 
#             quote = F, 
#             sep = "\t", row.names = F, col.names = T)
plotUMAP <- function(snapObject, 
                     colorBy, 
                     colorByLegendName, 
                     LegendRow =2,
                     outFolder,
                     outFile) {
  plotDF <- data.frame(UMAP1=snapObject@umap[,1],
             UMAP2=snapObject@umap[,2],
             ColorBy=colorBy
             )
  colnames(plotDF)[3] <- colorByLegendName
  
  p1 <- ggplot(plotDF, aes_string(x = "UMAP1", y = "UMAP2", color = colorByLegendName)) +
    geom_point(size = 1) + 
    theme_bw() +
    theme(legend.position="bottom") +
    guides(color=guide_legend(override.aes = list(size=1),
                             nrow=LegendRow, 
                             byrow=TRUE)) +
    theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),plot.background=element_blank())
  png(paste0(outFolder, "/", outFile, ".png"), 
      width = 11, 
      height = 8.5, 
      res = 300,
      units = "in")
  print(p1)
  dev.off()
  pdf(paste0(outFolder, "/", outFile, ".pdf"), 
      width = 11, 
      height = 8.5)
  print(p1)
  dev.off()
}
library(tidyverse)
plotUMAP(snapObject = ImmuneOnly.lda.sp, 
        colorBy = ImmuneOnly.lda.sp@cluster,
        colorByLegendName = "Cluster",
        outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneOnly////", 
        outFile = "ImmuneOnly_UMAP_Cluster")
plotUMAP(snapObject = ImmuneOnly.lda.sp, 
        colorBy = ImmuneOnly.lda.sp@metaData$GleasonScore,
        colorByLegendName = "GleasonScore",
        outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneOnly///", 
        outFile = "ImmuneOnly_UMAP_CleasonScore")
plotUMAP(snapObject = ImmuneOnly.lda.sp, 
        colorBy = ImmuneOnly.lda.sp@metaData$SampleNamePaper,
        colorByLegendName = "SampleNamePaper",
        outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneOnly///", 
        outFile = "ImmuneOnly_UMAP_SampleNamePaper")
plotUMAP(snapObject = ImmuneOnly.lda.sp, 
        colorBy = ImmuneOnly.lda.sp@metaData$SoftGleasonScore,
        colorByLegendName = "SampleNamePaper",
        outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneOnly///", 
        outFile = "ImmuneOnly_UMAP_SoftGleasonScore")
plotUMAP(snapObject = ImmuneOnly.lda.sp, 
        colorBy = ImmuneOnly.lda.sp@metaData$SoftGleasonScore,
        colorByLegendName = "GleasonScore",
        outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneOnly///", 
        outFile = "ImmuneOnly_UMAP_SampleNamePaper") 
dev.off()
library(GenomicRanges)
getTopicsBedFiles(TopicMatrix = getTopicWordMatrix(selectedModel = selectedModel), 
                  snapObject = ImmuneOnly.lda.sp, 
                  outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/ImmuneOnly/",
                  nRegions = 1500)














placholder
```

``` {r,}



## Clustering
library(leiden);
ImmuneOnly.lda.sp = runCluster(
	obj=ImmuneOnly.lda.sp,
	tmp.folder=tempdir(),
	louvain.lib="R-igraph",
	seed.use=10,
	resolution=0.1
	);

## Visualization
ImmuneOnly.lda.sp = runViz(
	obj=ImmuneOnly.lda.sp, 
	tmp.folder=tempdir(),
	dims=2,
	eigs.dims =seq(ImmuneOnly.lda.sp@smat@sdev), 
	weight.by.sd=TRUE,
	method="umap",
	fast_tsne_path=NULL,
	Y.init=ImmuneOnly.lda.sp@umap,
	seed.use=10,
	num.cores=10
	);

plotViz(
	obj=ImmuneOnly.lda.sp, 
	method="umap", 
	point.size=0.2, 
	point.shape=19, 
	point.alpha=0.8, 
  	point.color=ImmuneOnly.lda.sp@metaData$SampleNamePaper, 
	text.add=TRUE,
	text.size=0.5,
	text.color="black",
	text.halo.add=TRUE,
	text.halo.color="white",
	text.halo.width=0.2,
	down.sample=10000,
	pdf.file.name=NULL,
	pdf.width=7, 
	pdf.height=7,
	legend.add=T, 
	legend.pos = "top",
	main="snapATAC integrated LDA (cisTopic snapATAC)"
	)
plotGene(
	obj= ImmuneOnly.lda.sp,
	gene.names=c("PTPRC", "CD8A", "ITGAM", "SELL"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 2,
	plot.ncol = 2,
	low.value=0,
	high.value=0.75,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
ImmuneModel <- readRDS("~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/selected.ModelImmuneOnly.RDS")
library(pheatmap)

heatmap(Object = ImmuneOnly.lda.sp, 
        Topics = GetTopics(ImmuneModel, ImmuneOnly.lda.sp),
        Anno_Vector = ImmuneOnly.lda.sp@cluster, 
        Anno_Name = "Immune Clusters",
        outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March/Figures_Immune//", 
        outFile = "ImmuneOnly_TopicHeatmap_clusters"))
heatmap(Object = AllSamplesDecember.lda.sp, 
        Topics = GetTopics(selectedModel, AllSamplesDecember.lda.sp),
        Anno_Vector = AllSamplesDecember.lda.sp@cluster, 
        Anno_Name = "Cluster",
        
getTopicsBedFiles(TopicMatrix = getTopicWordMatrix(selectedModel = ImmuneModel), 
                  snapObject = ImmuneOnly.lda.sp, 
                  outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_March//Immune_Topics/",
                  nRegions = 1500)










AllSamplesDecember.lda.sp@metaData$Sample <- AllSamplesDecember.lda.sp@sample
GleasonPattern <- read.csv("~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_December/GleasonPattern.txt", sep = "\t")
GleasonPattern
GScore <- as.character(GleasonPattern$TumorGrade)
names(GScore) <- GleasonPattern$Sample
AllSamplesDecember.lda.sp@metaData$GleasonScore <- plyr::revalue(as.character(AllSamplesDecember.lda.sp@metaData$Sample),
                                        GScore)
table(AllSamplesDecember.lda.sp@metaData$GleasonScore)
## Plot
plotViz(
	obj=AllSamplesDecember.lda.sp, 
	method="umap", 
	point.size=0.2, 
	point.shape=19, 
	point.alpha=0.8, 
	point.color=AllSamplesDecember.lda.sp@cluster, 
	text.add=T,
	text.size=0.5,
	text.color="black",
	text.halo.add=TRUE,
	text.halo.color="white",
	text.halo.width=0.2,
	down.sample=10000,
	pdf.file.name=NULL,
	pdf.width=7, 
	pdf.height=7,
	legend.add=TRUE,
	main="snapATAC integrated LDA (cisTopic snapATAC)"
	)

heatmap <- function(Object, topics, test) {
  anno_col <- data.frame(row.names = paste(1:length(Object@barcode), Object@barcode, sep = "_"),
                         test=factor(AllSamplesDecember.lda.sp@metaData$GleasonScore, levels = c("Normal", "G3", "4+3", "G4", "Tumor")))
  p1 <- pheatmap(data.matrix(topics[order(anno_col$Score),]),
                 hclustfun = function(x) hclust(x, method="ward.D2"),
                 scale = "row",
                 cluster_cols = T,
                 cluster_rows = F,show_rownames = F,
                 col=colorRampPalette(rev(brewer.pal(11, "RdBu"))[c(1:4,8:11)])(256),
                 annotation_row = anno_col,
                 cex=1, main = "Topic Per Cell By Sample")
  return(p1)
}
heatmap(AllPlusJulySamples.lda.sp, GetTopics(selectedModel, AllSamplesDecember.lda.sp))
























library(GenomicFeatures)
library(umap)

genes <- read.table("~/Documents/Analysis/Ece_Prostate/snapATAC/gencode_v19_gene_pos.bed");
genes.gr = GRanges(genes[,1],
                   IRanges(genes[,2], genes[,3]),
                   name=genes[,4]
)
names(genes.gr) <- genes.gr$name
marker.genes <- c("FOXA1", "AR", "MEMCOM", "HOXB13")
rid <- grep("^MT", names(genes.gr))
genes.sel.gr <- genes.gr[-rid]

AllSamplesDecember.lda.sp <- createGmatFromMat(
  obj=AllSamplesDecember.lda.sp,
  genes= genes.sel.gr,
  do.par=TRUE,
  num.cores=11
	)
AllSamplesDecember.lda.sp = scaleCountMatrix(
	obj=AllSamplesDecember.lda.sp,
	cov=SnapATAC::rowSums(AllSamplesDecember.lda.sp, mat="bmat"),
	mat="gmat",
	method = "RPM"
	);
# saveRDS(selected.ModelAllPlusJuly, "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC/SelectedModel.RDS")
table(AllSamplesDecember.lda.sp@sample[AllSamplesDecember.lda.sp@cluster == 12]) / table(AllSamplesDecember.lda.sp@sample)
plotGene(
	obj=AllSamplesDecember.lda.sp,
	gene.names=c("CX3CL1", "TMPRSS2", "SERPINB1", "KRT5"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 2,
	plot.ncol = 2,
	low.value=0,
	high.value=0.75,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
grep("GRE", colnames(AllSamplesDecember.lda.sp@gmat), value = T)
library(SnapATAC)
nrow(DARs.G4_10VSG4_9_13)
nrow(DARs.G4_13VSG4_9_10)
nrow(DARs.G4_9VSG4_13_10)
table(DARs.G4_10VSG4_9_13$Peak %in% DARs.G4_9VSG4_13_10$Peak)
table(DARs.G4_13VSG4_9_10$Peak %in% DARs.G4_9VSG4_13_10$Peak)
table(DARs.G4_13VSG4_9_10$Peak %in% DARs.G4_10VSG4_9_13$Peak)
table(DARs.G4_10VSG4_9_13_PValue$Peak %in% DARs.G4_9VSG4_13_10_PValue$Peak)
table(DARs.G4_13VSG4_9_10_PValue$Peak %in% DARs.G4_9VSG4_13_10_PValue$Peak)
table(DARs.G4_13VSG4_9_10_PValue$Peak %in% DARs.G4_10VSG4_9_13_PValue$Peak)
findOverlaps(peaks.lda.gr[peaks.lda.gr$Peak %in% DARs.G4_10VSG4_9_13_PValue$Peak], 
             peaks.lda.gr[peaks.lda.gr$Peak %in% DARs.G4_13VSG4_9_10_PValue$Peak])

findOverlaps(peaks.lda.gr[peaks.lda.gr$Peak %in% DARs.G4_9VSG4_9_13_PValue$Peak], 
             peaks.lda.gr[peaks.lda.gr$Peak %in% DARs.G4_13VSG4_9_10_PValue$Peak])




plotGene(
	obj=AllSamplesDecember.lda.sp,
	gene.names=c("PIGA"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 1,
	plot.ncol = 1,
	low.value=0,
	high.value=2,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);





 ##### ERG Fusion
hist(AllSamplesDecember.lda.sp@gmat[,"ERG"], breaks = 100)#, ylim = c(0,100)) 
abline(v = sort(AllSamplesDecember.lda.sp@gmat[,"ERG"], decreasing = T)[200], col = "red")
highlight <- order(AllSamplesDecember.lda.sp@gmat[,"ERG"], decreasing = T)[1:200]
NotHighlight <- sample(which(AllSamplesDecember.lda.sp@gmat[,"ERG"] == 0), size = 1000)
plot(AllSamplesDecember.lda.sp@umap[,1], AllSamplesDecember.lda.sp@umap[,2], pch =16, cex = 0.2, main = "ERG")
points(AllSamplesDecember.lda.sp@umap[NotHighlight,1], AllSamplesDecember.lda.sp@umap[NotHighlight,2], col = "yellow", pch =16, cex = 0.3)
points(AllSamplesDecember.lda.sp@umap[highlight,1], AllSamplesDecember.lda.sp@umap[highlight,2], col = "red", pch =16, cex = 0.5)
AllSamplesDecember.lda.sp@metaData$ERG <- "ERG Neutral"
AllSamplesDecember.lda.sp@metaData$ERG[highlight] <- "ERG_Pos"
AllSamplesDecember.lda.sp@metaData$ERG[NotHighlight] <- "ERG_Neg"
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$ERG, 
                       ident.1 = c("ERG_Pos"),
                       ident.1.Name = "ERG_Pos", 
                       ident.2 = "ERG_Neg", 
                       ident.2.Name = "ERG_Neg_PValue",
                       PValue = 0.01)



set.seed(8)

plotGene(
	obj=AllSamplesDecember.lda.sp,
	gene.names=c("ETV1"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 1,
	plot.ncol = 1,
	low.value=0,
	high.value=2,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7)
hist(AllSamplesDecember.lda.sp@gmat[,"ETV1"], breaks = 100)#, ylim = c(0,100)) 
abline(v = sort(AllSamplesDecember.lda.sp@gmat[,"ETV1"], decreasing = T)[200], col = "red")
highlight <- order(AllSamplesDecember.lda.sp@gmat[,"ETV1"], decreasing = T)[1:200]
NotHighlight <- sample(which(AllSamplesDecember.lda.sp@gmat[,"ETV1"] == 0), size = 1000)
plot(AllSamplesDecember.lda.sp@umap[,1], AllSamplesDecember.lda.sp@umap[,2], pch =16, cex = 0.2, main = "ETV1")
points(AllSamplesDecember.lda.sp@umap[NotHighlight,1], AllSamplesDecember.lda.sp@umap[NotHighlight,2], col = "yellow", pch =16, cex = 0.3)
points(AllSamplesDecember.lda.sp@umap[highlight,1], AllSamplesDecember.lda.sp@umap[highlight,2], col = "red", pch =16, cex = 0.5)
AllSamplesDecember.lda.sp@metaData$ETV1 <- "ETV1 Neutral"
AllSamplesDecember.lda.sp@metaData$ETV1[highlight] <- "ETV1_Pos"
AllSamplesDecember.lda.sp@metaData$ETV1[NotHighlight] <- "ETV1_Neg"
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$ETV1, 
                       ident.1 = c("ETV1_Pos"),
                       ident.1.Name = "ETV1_Pos", 
                       ident.2 = "ETV1_Neg", 
                       ident.2.Name = "ETV1_Neg_PValue",
                       PValue = 0.01)




plotGene(
	obj=AllSamplesDecember.lda.sp,
	gene.names=c("ETV4"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 1,
	plot.ncol = 1,
	low.value=0,
	high.value=2,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7)
hist(AllSamplesDecember.lda.sp@gmat[,"ETV4"], breaks = 100)#, ylim = c(0,100)) 
abline(v = sort(AllSamplesDecember.lda.sp@gmat[,"ETV4"], decreasing = T)[200], col = "red")
highlight <- order(AllSamplesDecember.lda.sp@gmat[,"ETV4"], decreasing = T)[1:200]
NotHighlight <- sample(which(AllSamplesDecember.lda.sp@gmat[,"ETV4"] == 0), size = 1000)
plot(AllSamplesDecember.lda.sp@umap[,1], AllSamplesDecember.lda.sp@umap[,2], pch =16, cex = 0.2, main = "ETV4")
points(AllSamplesDecember.lda.sp@umap[NotHighlight,1], AllSamplesDecember.lda.sp@umap[NotHighlight,2], col = "yellow", pch =16, cex = 0.3)
points(AllSamplesDecember.lda.sp@umap[highlight,1], AllSamplesDecember.lda.sp@umap[highlight,2], col = "red", pch =16, cex = 0.5)
AllSamplesDecember.lda.sp@metaData$ETV4 <- "ETV4 Neutral"
AllSamplesDecember.lda.sp@metaData$ETV4[highlight] <- "ETV4_Pos"
AllSamplesDecember.lda.sp@metaData$ETV4[NotHighlight] <- "ETV4_Neg"
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$ETV4, 
                       ident.1 = c("ETV4_Pos"),
                       ident.1.Name = "ETV4_Pos", 
                       ident.2 = "ETV4_Neg", 
                       ident.2.Name = "ETV4_Neg_PValue",
                       PValue = 0.01)



plotGene(
	obj=AllSamplesDecember.lda.sp,
	gene.names=c("FLI1"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 1,
	plot.ncol = 1,
	low.value=0,
	high.value=2,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7)
hist(AllSamplesDecember.lda.sp@gmat[,"FLI1"], breaks = 100)#, ylim = c(0,100)) 
abline(v = sort(AllSamplesDecember.lda.sp@gmat[,"FLI1"], decreasing = T)[200], col = "red")
highlight <- order(AllSamplesDecember.lda.sp@gmat[,"FLI1"], decreasing = T)[1:200]
NotHighlight <- sample(which(AllSamplesDecember.lda.sp@gmat[,"FLI1"] == 0), size = 1000)
plot(AllSamplesDecember.lda.sp@umap[,1], AllSamplesDecember.lda.sp@umap[,2], pch =16, cex = 0.2, main = "FLI1")
points(AllSamplesDecember.lda.sp@umap[NotHighlight,1], AllSamplesDecember.lda.sp@umap[NotHighlight,2], col = "yellow", pch =16, cex = 0.3)
points(AllSamplesDecember.lda.sp@umap[highlight,1], AllSamplesDecember.lda.sp@umap[highlight,2], col = "red", pch =16, cex = 0.5)
AllSamplesDecember.lda.sp@metaData$FLI1 <- "FLI1 Neutral"
AllSamplesDecember.lda.sp@metaData$FLI1[highlight] <- "FLI1_Pos"
AllSamplesDecember.lda.sp@metaData$FLI1[NotHighlight] <- "FLI1_Neg"
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$FLI1, 
                       ident.1 = c("FLI1_Pos"),
                       ident.1.Name = "FLI1_Pos", 
                       ident.2 = "FLI1_Neg", 
                       ident.2.Name = "FLI1_Neg_PValue",
                       PValue = 0.01)









plotViz(
	obj=AllSamplesDecember.lda.sp, 
	method="umap", 
	point.size=0.2, 
	point.shape=19, 
	point.alpha=0.8, 
	point.color=AllSamplesDecember.lda.sp@metaData$ERG, 
	text.add=F,
	text.size=0.5,
	text.color="black",
	text.halo.add=TRUE,
	text.halo.color="white",
	text.halo.width=0.2,
	pdf.file.name=NULL,
	pdf.width=7, 
	pdf.height=7,
	legend.add=TRUE,
	main="snapATAC integrated LDA (cisTopic snapATAC)"
	)
plotGene(
	obj=AllSamplesDecember.lda.sp,
	gene.names=c("DLX1", "NOTCH1", "AR", "FOXA1", "HOXB13", "HOXC5", "PAQR6", "KLF4"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 4,
	plot.ncol = 2,
	low.value=0,
	high.value=0.75,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
plotGene(
	obj=AllSamplesDecember.lda.sp,
	gene.names=c("CD8A", "CD53", "CD14", "CD93"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 2,
	plot.ncol = 2,
	low.value=0,
	high.value=0.75,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
plotGene(
	obj=AllSamplesDecember.lda.sp,
	gene.names=c("KLK3", "KLK4"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 2,
	plot.ncol = 2,
	low.value=0,
	high.value=0.75,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);

plotGene(
	obj=AllSamplesDecember.lda.sp,
	gene.names=c("PTPRC", "FCGR2A", "ITGAX", "MS4A1"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 2,
	plot.ncol = 2,
	low.value=0,
	high.value=0.75,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
plotGene(
	obj=AllSamplesDecember.lda.sp,
	gene.names=c("GZMB", "CD163", "PDCD1", "CD274"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 2,
	plot.ncol = 2,
	low.value=0,
	high.value=0.75,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
plotGene(
	obj=AllSamplesDecember.lda.sp,
	gene.names=c("ERG", "MAOA", "DAD1", "NKX3-1"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 2,
	plot.ncol = 2,
	low.value=0,
	high.value=0.75,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
plotGene(
	obj=AllSamplesDecember.lda.sp,
	gene.names=c("HOTAIR", "PCA3", "NEAT1", "GAS5"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 2,
	plot.ncol = 2,
	low.value=0,
	high.value=0.75,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
plotGene(
	obj=AllSamplesDecember.lda.sp,
	gene.names=c("HOTAIR", "PCA3", "NEAT1", "GAS5"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 2,
	plot.ncol = 2,
	low.value=0,
	high.value=0.75,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
plotGene(
	obj=AllSamplesDecember.lda.sp,
	gene.names=c("DLX1", "ID2", "ID4", "NF1"),
	viz.method="umap",
  	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 2,
	plot.ncol = 2,
	low.value=0,
	high.value=1,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
plotGene(
	obj=AllSamplesDecember.lda.sp,
	gene.names=c("TMPRSS2"),
	viz.method="umap",
	point.size=1,
	point.color="red",
	point.shape=19,
	background.point=TRUE,
	background.point.color="grey",
	background.point.alpha=0.3,
	background.point.size=0.5,
	background.point.shape=19,
	plot.nrow = 1,
	plot.ncol = 1,
	low.value=0,
	high.value=0.75,
	down.sample=5000,
	seed.use=10,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
ADAM10 <- data.frame(barcode = AllSamplesDecember.lda.sp@barcode, 
           gene = AllSamplesDecember.lda.sp@gmat[, "ADAM10"],
           Sample = AllSamplesDecember.lda.sp@metaData$SoftGleasonScore)
ADAM10$gene[ADAM10$gene > 0] <- "Expressed"
ADAM10$gene[ADAM10$gene != "Expressed"] <- "Unexpressed"
ggplot(ADAM10, aes(x=Sample, y = gene, fill = gene)) + 
    geom_bar(position="fill", stat="identity")

plotFeatureSingle(
        obj=AllSamplesDecember.lda.sp,
        feature.value=AllSamplesDecember.lda.sp@gmat[, "VAX2"],
        method="umap", 
        main="VAX2",
        point.size=0.1, 
        point.shape=19, 
        down.sample=10000,
        quantiles=c(0, 0.8)
  )
# saveRDS(AllSamplesDecember.lda.sp, "AllPlusJulySamples_CisTopic_SnapATAC.RDS")
AllSamplesDecember.lda.sp <- readRDS("AllPlusJulySamples_CisTopic_SnapATAC.RDS")
ovs = as.data.frame(GenomicRanges::findOverlaps(AllSamplesDecember.lda.sp@feature, genes.gr));
ovs.ls = split(ovs, ovs$subjectHits);
idx.bin.i <- ovs.ls[[1]]$queryHits
count.1 <- AllSamplesDecember.lda.sp@bmat[,idx.bin.i, dropping=TRUE]
count.i = Matrix::rowSums(AllSamplesDecember.lda.sp@bmat[,idx.bin.i,dropping=TRUE]);	
i <- which(count.i > 0)
j <- ovs.ls[[1]]$subjectHits
count.i
val <- count.i[count.i > 0]
val
dn <- list(AllSamplesDecember.lda.sp@barcode, as.character(genes.gr$name))
Matrix::sparseMatrix(
		i=i, 
		j=j, 
		x=val, 
		dims=c(nrow(AllSamplesDecember.lda.sp), length(genes.gr)),
		dimnames = dn
	);
revalues <- c("G33_2"="G33_2",
              "G33_1" = "G33_1", 
              "G4_1" = "G4_1", 
              "190701" = "G33_3",
              "190717" = "G4_2")
AllSamplesDecember.lda.sp@sample <- plyr::revalue(as.character(AllPlusJulySamples.jda.sp@sample), revalues)

system("mkdir AllPlusJulySamples.ldaMACS")
peaks.lda.gr = runMACSForAll(
	obj=AllSamplesDecember.lda.sp,
	tmp.folder = "AllPlusJulySamples.ldaMACS",
	output.prefix="AllPlusJulySamples.lda",
	path.to.snaptools="/Users/chitsaza/miniconda3/bin/snaptools",
	path.to.macs="/Users/chitsaza/miniconda3/envs/scitools-env/bin/macs2",
	num.cores=11,
	min.cells=100,
	gsize="hs", 
	buffer.size = 500, 
	macs.options="--nomodel --shift 37 --ext 73 --qvalue 1e-2 -B --SPMR --call-summits"
	); 

seqlevels(peaks.lda.gr) <- gsub("b\'(.*)\'", "\\1", seqlevels(peaks.lda.gr))
peaks.lda.gr <- readRDS("~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_December/peaks.lda.janMilestone.lda")

## Enriched gleason score
AllSamplesDecember.lda.sp@metaData$EnrichedCluster <- "G3"
AllSamplesDecember.lda.sp@metaData$EnrichedCluster[grep("^1$|^3$|^9$|^10$",AllSamplesDecember.lda.sp@cluster)] <- "G4"
AllSamplesDecember.lda.sp@metaData$EnrichedCluster[grep("^12$",AllSamplesDecember.lda.sp@cluster)] <- "Stroma"
AllSamplesDecember.lda.sp@metaData$EnrichedCluster[grep("^7$",AllSamplesDecember.lda.sp@cluster)] <- "Immune"

## Soft Gleason Score
AllSamplesDecember.lda.sp@metaData$SoftGleasonScore <- "G3"
AllSamplesDecember.lda.sp@metaData$SoftGleasonScore[grep("^4\\+4$|^4\\+5$",AllSamplesDecember.lda.sp@metaData$GleasonScore)] <- "G4"
AllSamplesDecember.lda.sp@metaData$SoftGleasonScore <- "G3"
AllSamplesDecember.lda.sp@metaData$SoftGleasonScore[grep("^4\\+4$|^4\\+5$",AllSamplesDecember.lda.sp@metaData$GleasonScore)] <- "G4"

##IncreasedResolutionContrasts
AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution <- "G3"
AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution[grep("^1$|^3",AllSamplesDecember.lda.sp@cluster)] <- "G4_13"
AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution[grep("^9$",AllSamplesDecember.lda.sp@cluster)] <- "G4_9"
AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution[grep("^10$",AllSamplesDecember.lda.sp@cluster)] <- "G4_10"
AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution[which(AllSamplesDecember.lda.sp@cluster == "12" & AllSamplesDecember.lda.sp@metaData$SoftGleasonScore == "G4")] <- "Stroma_G4"
AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution[which(AllSamplesDecember.lda.sp@cluster == "12" & AllSamplesDecember.lda.sp@metaData$SoftGleasonScore == "G3")] <- "Stroma_G3"
AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution[which(AllSamplesDecember.lda.sp@cluster == "7" & AllSamplesDecember.lda.sp@metaData$SoftGleasonScore == "G4")] <- "Immune_G4"
AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution[which(AllSamplesDecember.lda.sp@cluster == "7" & AllSamplesDecember.lda.sp@metaData$SoftGleasonScore == "G3")] <- "Immune_G3"

ident.1 <- c("1", "3", "9", "10")
collapseIdentForGrep <- function(stringV) {
  stringV <- paste(stringV, collapse = "$|^")
  stringV <- paste0("^", stringV)
  stringV <- paste0(stringV, "$")
  return(stringV)
}
#### DIFFERENTIAL EXPRESSION
differentialExpression <- function(snapObject, 
                                   DEFactor, 
                                   ident.1, 
                                   ident.1.Name = "Ident.1", 
                                   ident.2 = NULL, 
                                   ident.2.Name = "Ident.2",
                                   outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_December/DARs/",
                                   peaks.gr = peaks.lda.gr,
                                   PValue = NULL,
                                   clusterNegMethod = FALSE,
                                   FDR = 5e-2,
                                   testMethod = "exactTest") {
  tmp.sp <- snapObject
  objectFile <- paste0(ident.1.Name, "VS", ident.2.Name)
  outFile <- paste0(outFolder, "/", objectFile)
  
  ## Set up contrasts
  tmp.DEFactor <- as.vector(DEFactor)
  ident.1 <- collapseIdentForGrep(ident.1)
  tmp.DEFactor[grep(ident.1, tmp.DEFactor)] <- ident.1.Name
  if (length(ident.2) > 0) {
    ## Change name of Ident 2 and Add to Factor
    ident.2 <- collapseIdentForGrep(ident.2)
    tmp.DEFactor[grep(ident.2, tmp.DEFactor)] <- ident.2.Name
    ## Only Keep Cells of Interest
    cellsOfInterest <- grep(paste(ident.1, ident.2, sep = "|"), as.vector(DEFactor))
    tmp.DEFactor <- tmp.DEFactor[cellsOfInterest]
    tmp.sp <- tmp.sp[cellsOfInterest,]
  } else {
    tmp.DEFactor[grep(ident.1, tmp.DEFactor, invert = T)] <- ident.2.Name
  }
  tmp.sp@cluster <- factor(tmp.DEFactor)
  if (clusterNegMethod == TRUE) {
    DARs <- findDAR(
      obj=tmp.sp,
      input.mat = "pmat",
      cluster.pos = ident.1.Name,
      cluster.neg=NULL,
      cluster.neg.method="knn",
      bcv = 0.4,
      test.method=testMethod,
      seed.use=10
    );
  } else {
    DARs <- findDAR(
      obj=tmp.sp,
      input.mat = "pmat",
      cluster.pos = ident.1.Name,
      cluster.neg = ident.2.Name,
      bcv = 0.4,
      test.method=testMethod,
      seed.use=10
    );
  }
  
  DARs$FDR = p.adjust(DARs$PValue, method="BH");
  DARs$Peak = paste0("Peak_",rownames(DARs))
  
  if (length(PValue) > 0) {
    idy = which(DARs$PValue < PValue & DARs$logFC > 0);
  } else {
    idy = which(DARs$FDR < FDR & DARs$logFC > 0);
  }
  numGenes <- length(idy)
  pdf(paste0(outFile, ".pdf"), width = 8, height = 6)
  p1 <- plot(DARs$logCPM, DARs$logFC, 
       pch=19, cex=0.1, col="grey", 
       ylab="logFC", xlab="logCPM",
       main=paste(ident.1.Name, "vs.", ident.2.Name, "( nRegions = ", numGenes, ")")
  )
  p1 <- points(DARs$logCPM[idy], 
         DARs$logFC[idy], 
         pch=19, 
         cex=0.5, 
         col="red"
  )
  p1 <- abline(h = 0, lwd=1, lty=2);
  dev.off()
  
  ##
  DARs <- DARs[idy,]
  DARs <- DARs[order(DARs$FDR),]
  assign(paste0("DARs.", objectFile), DARs, envir = .GlobalEnv)
  write.table(DARs, 
              file = paste0(outFile, ".txt"), 
              quote = F, sep = "\t", row.names = FALSE)
  
  ##
  Enriched.peaks <- peaks.gr[idy]
  convertGRangesToBED(GR = Enriched.peaks, outBedFile = paste0(outFile, ".bed"))
}
readRDS("../snapATAC_December/")
peaks.lda.gr$Peak <- paste0("Peak_", 1:length(peaks.lda.gr))
convertGRangesToBED <- function(GR, outBedFile) {
  outDF <- data.frame(seqnames=seqnames(GR),
                      starts=start(GR)-1,
                      ends=end(GR),
                      names = GR$Peak,
                      scores=c(rep("1000", length(GR))),
                      strands=c(rep(".", length(GR))))
  write.table(outDF, file= outBedFile, quote=F, sep="\t", row.names=F, col.names=F)
}
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$EnrichedCluster, 
                       ident.1 = c("G4"),
                       ident.1.Name = "G4", 
                       ident.2 = "G3", 
                       ident.2.Name = "G3")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$EnrichedCluster, 
                       ident.1 = c("G4"),
                       ident.1.Name = "G4", 
                       ident.2 = "G3", 
                       ident.2.Name = "G3_ClusterNeg",
                       clusterNegMethod = T)
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$EnrichedCluster, 
                       ident.1 = c("G4"),
                       ident.1.Name = "G4", 
                       ident.2 = "G3", 
                       ident.2.Name = "G3_LRT",
                       testMethod = "LRT")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$EnrichedCluster, 
                       ident.1 = c("G4"),
                       ident.1.Name = "G4", 
                       ident.2 = "G3", 
                       ident.2.Name = "G3_PValue",
                       PValue = 0.01)
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$EnrichedCluster, 
                       ident.1 = c("G3"),
                       ident.1.Name = "G3", 
                       ident.2 = "G4", 
                       ident.2.Name = "G4_PValue",
                       PValue = 0.01)
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$EnrichedCluster, 
                       ident.1 = c("G3"),
                       ident.1.Name = "G3", 
                       ident.2 = "G4", 
                       ident.2.Name = "G4")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@cluster, 
                       ident.1 = c("7"),
                       ident.1.Name = "7", 
                       ident.2.Name = "Not7")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("G4_10"),
                       ident.1.Name = "G4_10", 
                       ident.2 = "G3",
                       ident.2.Name = "G3")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("G4_10"),
                       ident.1.Name = "G4_10", 
                       ident.2 = "G3",
                       ident.2.Name = "G3_PValue",
                       PValue = 0.01)
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("G4_10"),
                       ident.1.Name = "G4_10", 
                       ident.2 = c("G4_13", "G4_9"),
                       ident.2.Name = "G4_9_13")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("G4_10"),
                       ident.1.Name = "G4_10", 
                       ident.2 = c("G4_13", "G4_9"),
                       ident.2.Name = "G4_9_13_PValue",
                       PValue = 0.01)
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("G4_9"),
                       ident.1.Name = "G4_9", 
                       ident.2 = c("G4_13", "G4_10"),
                       ident.2.Name = "G4_13_10")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("G4_9"),
                       ident.1.Name = "G4_9", 
                       ident.2 = c("G4_13", "G4_10"),
                       ident.2.Name = "G4_13_10_PValue",
                       PValue = 0.01)
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("G4_13"),
                       ident.1.Name = "G4_13", 
                       ident.2 = c("G4_9", "G4_10"),
                       ident.2.Name = "G4_9_10")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("G4_13"),
                       ident.1.Name = "G4_13", 
                       ident.2 = c("G4_9", "G4_10"),
                       ident.2.Name = "G4_9_10_PValue",
                       PValue = 0.01)



differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("G4_10"),
                       ident.1.Name = "G4_10", 
                       ident.2 = "G3",
                       ident.2.Name = "G3_LRT",
                       testMethod = "LRT")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("G4_13"),
                       ident.1.Name = "G4_1_3", 
                       ident.2 = "G3",
                       ident.2.Name = "G3")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("G4_13"),
                       ident.1.Name = "G4_1_3", 
                       ident.2 = "G3",
                       ident.2.Name = "G3_LRT",
                       testMethod = "LRT")
edifferentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("G4_13"),
                       ident.1.Name = "G4_1_3", 
                       ident.2 = "G3",
                       ident.2.Name = "G3_PValue",
                       PValue = 0.01)
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("G4_9"),
                       ident.1.Name = "G4_9", 
                       ident.2 = "G3",
                       ident.2.Name = "G3")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("G4_9"),
                       ident.1.Name = "G4_9", 
                       ident.2 = "G3",
                       ident.2.Name = "G3_LRT",
                       testMethod = "LRT")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("G4_9"),
                       ident.1.Name = "G4_9", 
                       ident.2 = "G3",
                       ident.2.Name = "G3_PValue", 
                       PValue = 0.01)
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("Immune_G4"),
                       ident.1.Name = "Immune_G4", 
                       ident.2 = "Immune_G3",
                       ident.2.Name = "Immune_G3")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("Immune_G4"),
                       ident.1.Name = "Immune_G4", 
                       ident.2 = "Immune_G3",
                       ident.2.Name = "Immune_G3_PValue",
                       PValue = 0.01)
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("Immune_G3"),
                       ident.1.Name = "Immune_G3", 
                       ident.2 = "Immune_G4",
                       ident.2.Name = "Immune_G4_LRT",
                       testMethod = "LRT")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("Immune_G3"),
                       ident.1.Name = "Immune_G3", 
                       ident.2 = "Immune_G4",
                       ident.2.Name = "Immune_G4_PValue",
                       PValue = 0.01)
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("Stroma_G3"),
                       ident.1.Name = "Stroma_G3", 
                       ident.2 = "Stroma_G4",
                       ident.2.Name = "Stroma_G4")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("Stroma_G3"),
                       ident.1.Name = "Stroma_G3", 
                       ident.2 = "Stroma_G4",
                       ident.2.Name = "Stroma_G4_LRT",
                       testMethod = "LRT")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("Stroma_G3"),
                       ident.1.Name = "Stroma_G3", 
                       ident.2 = "Stroma_G4",
                       ident.2.Name = "Stroma_G4_PValue", 
                       PValue = 0.01)
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = AllSamplesDecember.lda.sp@metaData$IncreasedEnrichedResolution, 
                       ident.1 = c("Stroma_G4"),
                       ident.1.Name = "Stroma_G4", 
                       ident.2 = "Stroma_G3",
                       ident.2.Name = "Stroma_G3_PValue", 
                       PValue = 0.01)
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = unique(AllSamplesDecember.lda.sp@sample), 
                       ident.1 = c("WM306009"),
                       ident.1.Name = "Tumor_09", 
                       ident.2 = "WM306010",
                       ident.2.Name = "Normal_10")
differentialExpression(snapObject = AllSamplesDecember.lda.sp, 
                       DEFactor = unique(AllSamplesDecember.lda.sp@sample), 
                       ident.1 = c("WM306009"),
                       ident.1.Name = "Tumor_09", 
                       ident.2 = "WM306010",
                       ident.2.Name = "Normal_10_PValue",
                       PValue = 0.05)














library(chromVAR)
library(chromVAR);
library(motifmatchr);
library(SummarizedExperiment);
library(BSgenome.Hsapiens.UCSC.hg19);
AllSamplesDecember.lda.motifs.sp = makeBinary(AllSamplesDecember.lda.sp, "pmat")
AllSamplesDecember.lda.motifs.sp@mmat = runChromVAR(
    obj=AllSamplesDecember.lda.motifs.sp,
    input.mat="pmat",
    genome=BSgenome.Hsapiens.UCSC.hg19,
    min.count = 10,
    species="Homo sapiens"
  );

motif_i <- grep("RORA", colnames(AllSamplesDecember.lda.motifs.sp@mmat), value = T)
motif_i <- motif_i[1]
dat = data.frame(x=AllSamplesDecember.lda.motifs.sp@metaData$IncreasedEnrichedResolution, y=AllSamplesDecember.lda.motifs.sp@mmat[,motif_i]);
library(tidyverse)
ggplot(dat, aes(x=x, y=y, fill=x)) + 
	theme_classic() +
	geom_violin() + 
	xlab("cluster") +
	ylab("motif enrichment") + 
	ggtitle(motif_i)+ theme(legend.position = "none")


motif_i = "MA0902.1_HOXB2";
BED <- read.table("~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_December/DARs/G4VSG3_PValue_OverlapBedtools.bed")
BED_Intersect <- BED[BED$V5 == "1,2,3",]
BED_Intersect <- data.frame(seqnames=BED_Intersect$V1,
                      starts=BED_Intersect$V2-1,
                      ends=BED_Intersect$V3,
                      names = rep(".", nrow(BED_Intersect)),
                      scores=c(rep("1000", nrow(BED_Intersect))),
                      strands=c(rep(".", nrow(BED_Intersect))))

write.table(BED_Intersect, file= "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_December/DARs/G4VSG3_PValue_OverlapBedtools_Test.bed", quote=F, sep="\t", row.names=F, col.names=F)






Test.lda.sp <- AllSamplesDecember.lda.sp
clusters <- as.vector(Test.lda.sp@cluster)
AllSamplesDecember.lda.sp[c(1,2),]
clusters[clusters != 9 ] <- 0
Test.lda.sp@cluster <- factor(clusters)
table(Test.lda.sp@cluster)
DARs.C9 = findDAR(
	obj=Test.lda.sp,
	input.mat = "pmat",
	cluster.pos=9,
	cluster.neg = 0,
	bcv = 0.4,
	test.method="exactTest",
	seed.use=10
	);

DARs.C9$FDR = p.adjust(DARs.C9$PValue, method="BH");
idy = which(DARs.C9$FDR < 5e-2 & DARs.C9$logFC > 0);
plot(DARs.C9$logCPM, DARs.C9$logFC, 
    pch=19, cex=0.1, col="grey", 
    ylab="logFC", xlab="logCPM",
    main="Cluster 26"
  );
points(DARs.C9$logCPM[idy], 
    DARs.C9$logFC[idy], 
    pch=19, 
    cex=0.5, 
    col="red"
  );
abline(h = 0, lwd=1, lty=2);

y_C2 = SnapATAC::rowSums(AllSamplesDecember.lda.sp[,idy_C2,mat="pmat"], mat="pmat") / SnapATAC::rowSums(AllSamplesDecember.lda.sp, mat="pmat") * 1000000;

# normalize to zscore
y_C2 = (y_C2 - mean(y_C2)) / sd(y_C2);
boxPlotFeature(
	obj = Test.lda.sp,
	feature = y_C2,
	outline = FALSE,
	ylab = "zscore of RPM",
	main = "Sst DARs Enrichment",
	add.point = TRUE,
	point.size = 0.2,
	point.shape = 19,
	point.alpha = 0.5,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
length(peaks.lda.gr)
nrow(DARs.C9)
cluster9.Enriched.peaks <- peaks.lda.gr[idy_C2]

convertGRangesToBED <- function(GR, outBedFile) {
  outDF <- data.frame(seqnames=seqnames(GR),
                      starts=start(GR)-1,
                      ends=end(GR),
                      names=c(rep(".", length(GR))),
                      scores=c(rep("1000", length(GR))),
                      strands=c(rep(".", length(GR))))
  write.table(outDF, file= outBedFile, quote=F, sep="\t", row.names=F, col.names=F)
}
convertGRangesToBED(cluster9.Enriched.peaks, "cluster9.enriched.peaks.bed")







## Cluster8
Test.lda.sp <- AllSamplesDecember.lda.sp
clusters <- as.vector(Test.lda.sp@cluster)
clusters[clusters != 8 ] <- 0
Test.lda.sp@cluster <- factor(clusters)
table(Test.lda.sp@cluster)
DARs.C8 = findDAR(
	obj=Test.lda.sp,
	mat="pmat",
	cluster.pos=8,
	cluster.neg = 0,
	bcv = 0.4,
	fdr=0.01,
	pvalue=1e-2,
	test.method="exactTest",
	seed.use=10
	);

idy_C2 <- which(DARs.C8$label == 1)
y_C2 = SnapATAC::rowSums(AllSamplesDecember.lda.sp[,idy_C2,mat="pmat"], mat="pmat") / SnapATAC::rowSums(AllSamplesDecember.lda.sp, mat="pmat") * 1000000;
# normalize to zscore
y_C2 = (y_C2 - mean(y_C2)) / sd(y_C2);
boxPlotFeature(
	obj = Test.lda.sp,
	feature = y_C2,
	outline = FALSE,
	ylab = "zscore of RPM",
	main = "Sst DARs Enrichment",
	add.point = TRUE,
	point.size = 0.2,
	point.shape = 19,
	point.alpha = 0.5,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
length(peaks.lda.gr)
nrow(DARs.C8)
cluster8.Enriched.peaks <- peaks.lda.gr[idy_C2]

convertGRangesToBED <- function(GR, outBedFile) {
  outDF <- data.frame(seqnames=seqnames(GR),
                      starts=start(GR)-1,
                      ends=end(GR),
                      names=c(rep(".", length(GR))),
                      scores=c(rep("1000", length(GR))),
                      strands=c(rep(".", length(GR))))
  write.table(outDF, file= outBedFile, quote=F, sep="\t", row.names=F, col.names=F)
}
convertGRangesToBED(cluster8.Enriched.peaks, "cluster8.enriched.peaks.bed")





### Specific for 8 vs 9
DARs.C8 = findDAR(
	obj=AllSamplesDecember.lda.sp,
	mat="pmat",
	cluster.pos=8,
	cluster.neg = 9,
	bcv = 0.4,
	fdr=0.01,
	pvalue=1e-2,
	test.method="exactTest",
	seed.use=10
	);

idy_C2 <- which(DARs.C8$label == 1)
y_C2 = SnapATAC::rowSums(AllSamplesDecember.lda.sp[,idy_C2,mat="pmat"], mat="pmat") / SnapATAC::rowSums(AllSamplesDecember.lda.sp, mat="pmat") * 1000000;
# normalize to zscore
y_C2 = (y_C2 - mean(y_C2)) / sd(y_C2);
boxPlotFeature(
	obj = AllSamplesDecember.lda.sp,
	feature = y_C2,
	outline = FALSE,
	ylab = "zscore of RPM",
	main = "Sst DARs Enrichment",
	add.point = TRUE,
	point.size = 0.2,
	point.shape = 19,
	point.alpha = 0.5,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
length(peaks.lda.gr)
nrow(DARs.C8)
cluster8v9.Enriched.peaks <- peaks.lda.gr[idy_C2]

convertGRangesToBED <- function(GR, outBedFile) {
  outDF <- data.frame(seqnames=seqnames(GR),
                      starts=start(GR)-1,
                      ends=end(GR),
                      names=c(rep(".", length(GR))),
                      scores=c(rep("1000", length(GR))),
                      strands=c(rep(".", length(GR))))
  write.table(outDF, file= outBedFile, quote=F, sep="\t", row.names=F, col.names=F)
}
convertGRangesToBED(cluster8v9.Enriched.peaks, "cluster8v9.enriched.peaks.bed")









### Specific for 8 vs 9
DARs.C8 = findDAR(
	obj=AllSamplesDecember.lda.sp,
	mat="pmat",
	cluster.pos=9,
	cluster.neg = 8,
	bcv = 0.4,
	fdr=0.01,
	pvalue=1e-2,
	test.method="exactTest",
	seed.use=10
	);

idy_C2 <- which(DARs.C8$label == 1)
y_C2 = SnapATAC::rowSums(AllSamplesDecember.lda.sp[,idy_C2,mat="pmat"], mat="pmat") / SnapATAC::rowSums(AllSamplesDecember.lda.sp, mat="pmat") * 1000000;
# normalize to zscore
y_C2 = (y_C2 - mean(y_C2)) / sd(y_C2);
boxPlotFeature(
	obj = AllSamplesDecember.lda.sp,
	feature = y_C2,
	outline = FALSE,
	ylab = "zscore of RPM",
	main = "Sst DARs Enrichment",
	add.point = TRUE,
	point.size = 0.2,
	point.shape = 19,
	point.alpha = 0.5,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
length(peaks.lda.gr)
nrow(DARs.C8)
cluster9v8.Enriched.peaks <- peaks.lda.gr[idy_C2]

convertGRangesToBED <- function(GR, outBedFile) {
  outDF <- data.frame(seqnames=seqnames(GR),
                      starts=start(GR)-1,
                      ends=end(GR),
                      names=c(rep(".", length(GR))),
                      scores=c(rep("1000", length(GR))),
                      strands=c(rep(".", length(GR))))
  write.table(outDF, file= outBedFile, quote=F, sep="\t", row.names=F, col.names=F)
}
convertGRangesToBED(cluster9v8.Enriched.peaks, "cluster9v8.enriched.peaks.bed")
cluster8.Enriched.peaks
cluster8v9.Enriched.peaks
cluster9v8.Enriched.peaks
cluster8.Enriched.peaks
cluster9.Enriched.peaks





## Cluster12
Test.lda.sp <- AllSamplesDecember.lda.sp
clusters <- as.vector(Test.lda.sp@cluster)
clusters[clusters != 12 ] <- 0
Test.lda.sp@cluster <- factor(clusters)
table(Test.lda.sp@cluster)
DARs.C8 = findDAR(
	obj=Test.lda.sp,
	mat="pmat",
	cluster.pos=0,
	cluster.neg = 12,
	bcv = 0.4,
	fdr=0.01,
	pvalue=1e-2,
	test.method="exactTest",
	seed.use=10
	);
idy_C2 <- head(order(DARs.C8$logFC, decreasing = F), 250)
y_C2 = SnapATAC::rowSums(AllSamplesDecember.lda.sp[,idy_C2,mat="pmat"], mat="pmat") / SnapATAC::rowSums(AllSamplesDecember.lda.sp, mat="pmat") * 1000000;
# normalize to zscore
y_C2 = (y_C2 - mean(y_C2)) / sd(y_C2);
boxPlotFeature(
	obj = Test.lda.sp,
	feature = y_C2,
	outline = FALSE,
	ylab = "zscore of RPM",
	main = "Sst DARs Enrichment",
	add.point = TRUE,
	point.size = 0.2,
	point.shape = 19,
	point.alpha = 0.5,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
length(peaks.lda.gr)
nrow(DARs.C8)
cluster8.Enriched.peaks <- peaks.lda.gr[idy_C2]

convertGRangesToBED <- function(GR, outBedFile) {
  outDF <- data.frame(seqnames=seqnames(GR),
                      starts=start(GR)-1,
                      ends=end(GR),
                      names=c(rep(".", length(GR))),
                      scores=c(rep("1000", length(GR))),
                      strands=c(rep(".", length(GR))))
  write.table(outDF, file= outBedFile, quote=F, sep="\t", row.names=F, col.names=F)
}
convertGRangesToBED(cluster8.Enriched.peaks, "cluster12NEG.enriched.peaks.bed")



## Cluster12
AllSamplesDecember.lda.sp@sample
Test.lda.sp <- AllSamplesDecember.lda.sp
clusters <- as.vector(Test.lda.sp@cluster)
clusters[grep("G33_1|G33_2|G33_3", Test.lda.sp@sample)] <- "G33"
clusters[grep("G4_1|G4_2", Test.lda.sp@sample)] <- "G4"
Test.lda.sp@cluster <- factor(clusters)
table(Test.lda.sp@cluster)
DARs.C8 = findDAR(
	obj=Test.lda.sp,
	mat="pmat",
	cluster.pos="G4",
	cluster.neg = "G33",
	bcv = 0.4,
	fdr=0.01,
	pvalue=1e-2,
	test.method="exactTest",
	seed.use=10
	);

idy_C2 <- which(DARs.C8$label == 1)
y_C2 = SnapATAC::rowSums(AllSamplesDecember.lda.sp[,idy_C2,mat="pmat"], mat="pmat") / SnapATAC::rowSums(AllSamplesDecember.lda.sp, mat="pmat") * 1000000;
# normalize to zscore
y_C2 = (y_C2 - mean(y_C2)) / sd(y_C2);
boxPlotFeature(
	obj = Test.lda.sp,
	feature = y_C2,
	outline = FALSE,
	ylab = "zscore of RPM",
	main = "Sst DARs Enrichment",
	add.point = TRUE,
	point.size = 0.2,
	point.shape = 19,
	point.alpha = 0.5,
	pdf.file.name=NULL,
	pdf.height=7,
	pdf.width=7
	);
length(peaks.lda.gr)
nrow(DARs.C8)
cluster8.Enriched.peaks <- peaks.lda.gr[idy_C2]

convertGRangesToBED <- function(GR, outBedFile) {
  outDF <- data.frame(seqnames=seqnames(GR),
                      starts=start(GR)-1,
                      ends=end(GR),
                      names=c(rep(".", length(GR))),
                      scores=c(rep("1000", length(GR))),
                      strands=c(rep(".", length(GR))))
  write.table(outDF, file= outBedFile, quote=F, sep="\t", row.names=F, col.names=F)
}
convertGRangesToBED(cluster8.Enriched.peaks, "G4vsG33.enriched.peaks.bed")

motifs = runHomer(
	Test.lda.sp[,idy_C2,"pmat"], 
	mat = "pmat",
	path.to.homer = "/Users/chitsaza/miniconda3/envs/scitools-env/bin/findMotifsGenome.pl",
	result.dir = "./homer/G4vsG33",
	num.cores=5,
	genome = 'hg19',
	motif.length = 10,
	scan.size = 300,
	optimize.count = 2,
	background = 'automatic',
	local.background = FALSE,
	only.known = FALSE,
	only.denovo = FALSE,
	fdr.num = 5,
	cache = 100,
	overwrite = TRUE,
	keep.minimal = FALSE
	);


DocumentTopicMatrix <- AllSamplesDecember.lda.sp@smat@dmat

rownames(DocumentTopicMatrix) <- paste(1:length(AllSamplesDecember.lda.sp@barcode), AllSamplesDecember.lda.sp@barcode, sep = "_")
colnames(DocumentTopicMatrix) <- paste("Topic", 1:30)
anno_col <- data.frame(row.names = paste(1:length(AllSamplesDecember.lda.sp@barcode), AllSamplesDecember.lda.sp@barcode, sep = "_"),
                       Cluster=AllSamplesDecember.lda.sp@cluster)
anno_col <- data.frame(row.names = paste(1:length(AllSamplesDecember.lda.sp@barcode), AllSamplesDecember.lda.sp@barcode, sep = "_"),
                       Sample=AllSamplesDecember.lda.sp@sample)

library(pheatmap)
library(RColorBrewer)
aano_col
pheatmap(data.matrix(DocumentTopicMatrix[order(anno_col$Cluster),]),
         hclustfun = function(x) hclust(x, method="ward.D2"),
         scale = "row",
         cluster_cols = T,
         cluster_rows = F,show_rownames = F,
         col=colorRampPalette(rev(brewer.pal(11, "RdBu"))[c(1:4,8:11)])(256),
         annotation_row = anno_col,
         cex=1)
pheatmap(data.matrix(DocumentTopicMatrix[order(anno_col$Sample),]),
         hclustfun = function(x) hclust(x, method="ward.D2"),
         scale = "row",
         cluster_cols = T,
         cluster_rows = F,show_rownames = F,
         col=colorRampPalette(rev(brewer.pal(11, "RdBu"))[c(1:4,8:11)])(256),
         annotation_row = anno_col,
         cex=1)
getTopicsBedFiles(selected.ModelAllPlusJuly, AllSamplesDecember.lda.sp, outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC/AllPlusJulyTopics/")
hist(scale(selected.Model$topics, center=TRUE, scale=TRUE)[12,], breaks = 1000)
ncol(selected.Model$topics)
test <- scale(selected.Model$topics, center=TRUE, scale=TRUE)
G4_1.lda.sp@bmat[,which(Matrix::colSums(G4_1.lda.sp@bmat) > 10)]
selected.Model$topics
G4_1.lda.sp@feature
length(G4_1.lda.sp@feature)
selectedModel <- readRDS("SelectedModel.RDS")
AllSamplesDecember.lda.sp@barcode == gsub("[0-9]+_", "", rownames(DocumentTopicMatrix))

par(mfrow = c(3, 3));
for (i in 1:30) {
  plotFeatureSingle(
    obj=AllSamplesDecember.lda.sp,
    feature.value=DocumentTopicMatrix[,paste("Topic", i, sep = " ")],
    method="umap", 
    main=paste("Topic", i, sep = " "),
    point.size=0.2, 
    point.shape=19)
}
plotFeatureSingle(
    obj=AllSamplesDecember.lda.sp,
    feature.value=DocumentTopicMatrix[,"Topic 7"],
    method="umap", 
    main="10X Brain Read Depth",
    point.size=0.2, 
    point.shape=19)#,
    #quantiles=c(0.01, 0.99))
head(DocumentTopicMatrix)
length(DocumentTopicMatrix[,"Topic 24"])
### Cistopic Heatmap
AllSamplesDecember.lda.sp@bmat

getTopicWordMatrix <- function(selectedModel) {
  topic.mat <- selectedModel$topics
  ## cisTopic code  
  beta  <- 0.1
  modelMat <-  (topic.mat + beta)/rowSums(topic.mat + beta)
  return(modelMat)
}

convertGRangesToBED <- function(GR, outBedFile) {
  outDF <- data.frame(seqnames=seqnames(GR),
                      starts=format(start(GR)-1, scientific = FALSE),
                      ends=format(end(GR), scientific = FALSE),
                      names=c(rep(".", length(GR))),
                      scores=c(rep("1000", length(GR))),
                      strands=c(rep(".", length(GR))))
  write.table(outDF, file= outBedFile, quote=F, sep="\t", row.names=F, col.names=F)
}
getTopicsBedFiles <- 
  function(TopicMatrix, 
           snapObject, 
           outFolder, 
           min.cell = 10,
           nRegions = 1000) {
  if (!dir.exists(outFolder)) {
    dir.create(outFolder)
  }
  ## Get feature matrix output 
  FeatureTopicMatrix <- t(TopicMatrix)
  
  ## Filter out cells not used in the LDA tranformation
  idx <- which(Matrix::colSums(snapObject@bmat) > min.cell)
  for (i in 1:ncol(FeatureTopicMatrix)) {
    topic.gr <- snapObject@feature[idx][order(FeatureTopicMatrix[,i], decreasing = T)[1:nRegions]]
    convertGRangesToBED(GR = topic.gr, outBedFile = paste0(outFolder, "/topic", as.character(i), ".bed"))
  }
  return(idx)
  }

getTopicsBedFiles(TopicMatrix = modelMat, 
                  snapObject = AllSamplesDecember.lda.sp, 
                  outFolder = "~/Box Sync/Alex_Data/Ece_scATAC/snapATAC_December/AllPlusDecemberTopics_Jan/",
                  nRegions = 1500)

plotFeatureSingle(
    obj=AllSamplesDecember.lda.sp,
    feature.value=AllSamplesDecember.lda.sp@metaData$UM,
    method="umap",
    main="Unique fragments capped @ 0.6 quantile",
    point.size=0.2,
    point.shape=19, 
    down.sample=10000,
    quantiles=c(0.01, 0.6)) 







```

